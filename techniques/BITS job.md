### Origin of the technique
Microsoft Windows Background Intelligent Transfer Service (BITS) is used for file transfer between machines and is accessible as a COM server. It is used for example by Windows Update to download updates. The option `/SetNotifyCmdLine` is used to specify a command that is executed when a job is done transferring or in error.


### How to achieve persistence
Set up a BITS job using the following commands:
```powershell
bitsadmin /create my_persistence 
bitsadmin /addfile my_persistence c:\windows\system32\net.exe c:\users\ieuser\desktop\hi.log  
bitsadmin /SetNotifyCmdLine my_persistence "c:\path\to\executable" NULL  
bitsadmin /Resume my_persistence
```
BITS jobs are not stored in the registry but in a separate database.

### Requirements
User privileges are enough.
The database storing the jobs is in `%ALLUSERSPROFILE%\Microsoft\Network\Downloader\qmgr.db` using the Extensible Storage Engine (ESE) format.
"QMGR database files are opened without sharing by the BITS service thus preventing other programs from directly opening them.". In other words, you have to use the bitsadmin tool or the COM object.

Before windows 10 it was stored in `qmgr0.dat` and `qmgr1.dat`

### The achieved persistence
The command is executed periodically. It stays active for 90 days, or after download is completed.


### More information
- https://www.mandiant.com/resources/blog/attacker-use-of-windows-background-intelligent-transfer-service
- https://www.trustedsec.com/blog/bits-persistence-for-script-kiddies/
- https://attack.mitre.org/techniques/T1197/
- https://unit42.paloaltonetworks.com/unit42-uboatrat-navigates-east-asia/
- https://www.secureworks.com/blog/malware-lingers-with-bits
